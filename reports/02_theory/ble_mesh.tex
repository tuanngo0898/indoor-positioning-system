\providecommand{\main}{..}
\documentclass[\main/main.tex]{subfiles}

\begin{document}
\graphicspath{{img/}{02_theory/img/}}

\chapter{Bluetooth mesh}

\section{Introduction}
Bluetooth mesh networking provides the foundation to create a truly large-scale device network, allowing tens, hundreds or even thousands of wireless devices to communicate with each other reliably and securely.

Compared with other topologies, in a mesh network, each node may have a direct communication link with many nodes. This brings the robustness to the network against the single point of failure problem but also makes it harder to manage. Figure \ref{fig:Mesh topology} illustrates a basic example of mesh topology.

\begin{figure}[H]
    \begin{center}
        \includegraphics[scale=0.3]{mesh_topo.png}
    \end{center}
    \caption{Mesh topology}
    \label{fig:Mesh topology}
\end{figure}

A BLE mesh capable device which is not a member of any BLE mesh network is called \textbf{unprovisioned device}. After joining a  network, it is eligible to call it a \textbf{node}. The action of making an unprovisioned device become a node is called \textbf{provision}.

There may be more than one kind of node existing in a BLE mesh network. Each kind plays a different role working together to make the network run. Five types of nodes are defined in the \textbf{Mesh Networking Specifications} published by Bluetooth SIG (Bluetooth Special Interest Group).
\begin{itemize}
    \item Normal node (usually called node)
    \item Relay node
    \item Low power node
    \item Friend node
    \item Proxy node
\end{itemize}
\section{Node software architecture}
Figure \ref{fig:Node software architecture} shows the software architecture of a node. In application implementation, understanding each component is required because there are the needs of defining each of them in memory. The details of each component is discussed in the following subsection.
\begin{figure}[H]
    \begin{center}
        \includegraphics[scale=0.15]{node_software_architecture.jpg}
    \end{center}
    \caption{Node software architecture}
    \label{fig:Node software architecture}
\end{figure}

\subsection{Element}
In a BLE mesh network, a node is a physical device consisting of one or more elements. Compared to the node, an element is the logic component of the network. By this way, a mesh network is logically a group of elements communicating with others. Because an element is a network entity, it will be addressed uniquely in the mesh network.

Why element is defined? Let's think of a device with more than one light bulb, by introducing the element concept, each light bulb may be considered as an element of the network. This makes the network more flexible and removes application layer special muxing.

\subsection{Model}
The communication channel between elements is the model. A model can subscribe to a topic or publish data to a topic that may be subscribed by other models. The publish/subscribe pattern brings the ability to  communicate with multiple devices with a single message without knowing the exact address of such devices. Figure \ref{fig:BLE mesh publish/subscribe model} illustrates the publish/subscribe pattern. 

\begin{figure}[H]
    \begin{center}
        \includegraphics[scale=0.4]{ble_mesh_pub_sub.png}
    \end{center}
    \caption{BLE mesh publish/subscribe model}
    \label{fig:BLE mesh publish/subscribe model}
\end{figure}

\subsection{State}
A state is an internal variable inside the model. In the simple case, it may save a state of the element such as the on/off state of a light bulb.

\section{Security \cite{web_bluetooth_mesh_security_overview}}
One of the most discussed issues related to the Internet of Things (IoT) is security. From agriculture to hospitals, from residential smart homes to commercial smart buildings, and from power stations to traffic management systems, IoT systems and technologies will touch many parts of the world we live in. Security breaches in IoT systems could have catastrophic consequences.

Bluetooth mesh networking was designed with security as its number one priority and from the ground up. In this article, you’ll get an overview of the key security features and the security issues addressed. Further articles in the series will examine aspects of Bluetooth mesh networking security in more detail

\subsection{Security in Bluetooth Mesh Networking is mandatory}
Bluetooth Low Energy (LE) GATT devices may implement a range of security measures as defined in the Bluetooth core specification. It’s the responsibility of the product designer to decide what security measures are required and it’s permissible to decide to adopt none of the available security features at all. In other words, security in Bluetooth Low Energy GATT is optional. This makes sense if we’re talking about the security of a single device and its connection with one other device, provided the product designer performs their risk assessment correctly. However, security in Bluetooth mesh networking is concerned with the security of more than individual devices or connections between peer devices; it’s concerned with the security of an entire network of devices and of various groupings of devices in the network.

Consequently, security in Bluetooth mesh networking is mandatory.

\subsection{Bluetooth Mesh Networking Security Fundamentals}
The following fundamental security statements apply to all Bluetooth mesh networks.

\begin{table}[H]
    \centering
    \begin{tabular}{|m{0.3\textwidth}|m{0.65\textwidth}|}
    \hline
    % \centering  &  \centering  \\\hline
    \multicolumn{1}{|>{\centering\arraybackslash}m{0.3\textwidth}|}{\textbf{Security statements}} & \multicolumn{1}{>{\centering\arraybackslash}m{0.65\textwidth}|}{\textbf{Description}}\\
    \hline

    Encryption and Authentication &  All Bluetooth mesh messages are encrypted and authenticated. \\ \hline
    Separation of Concerns & Network security, application security, and device security are addressed independently.\\ \hline
    Area Isolation & A Bluetooth mesh network can be divided into subnets, each cryptographically distinct and secure from the others. \\ \hline
    Key Refresh & Security keys can be changed during the life of the Bluetooth mesh network via a Key Refresh procedure. \\ \hline
    Message Obfuscation & Message obfuscation makes it difficult to track messages sent within the network and, as such, provides a privacy mechanism to make it difficult to track nodes. \\\hline
    Replay Attack Protection & Bluetooth mesh security protects the network against replay attacks. \\\hline
    Trashcan Attack Protection & Nodes can be removed from the network securely, in a way which prevents trashcan attacks. \\\hline
    Secure Device Provisioning & The process by which devices are added to the Bluetooth mesh network to become nodes is a secure process. \\\hline
    \end{tabular}
    \caption{Security statements}
    \label{table:security_statements}
\end{table}

\subsection{Separation of Concerns and Security Keys}
At the heart of Bluetooth® mesh security are three types of security keys. These keys provide security to different aspects of the Bluetooth mesh network and achieve a critical capability in Bluetooth mesh networking security called a separation of concerns.

Consider a mesh light which acts as a relay. In its capacity as a relay, it may find itself handling messages relating to the building’s Bluetooth mesh door and window security system. A light has no business accessing and processing the details of these messages, but it does need to relay them to other nodes.

To deal with this potential conflict of interest, Bluetooth mesh uses different security keys called \textbf{AppKeys} for securing messages at the network layer from those used to secure data relating to specific applications, such as lighting, physical security, heating, etc.

All nodes in a Bluetooth mesh network possess one or more \textbf{Network Keys (NetKey)}, each corresponding to a subnet which may be the primary subnet. It’s possession of a network key which makes a node a member of the network. Network Encryption Keys and Privacy Keys are derived directly from the NetKey.

Being in possession of a NetKey allows a node to decrypt and authenticate up to the Network Layer so that network functions, such as relaying, can be carried out. It does not allow application data to be decrypted.

Each node also has a unique security key called the \textbf{Device Key or DevKey}. The DevKey is used in the provisioning and configuration of the node.

\subsection{Area Isolation}
Possession of the primary NetKey defines membership of and grants access to the Bluetooth® mesh network. But it’s also possible to divide the network into distinct subnets, each with its own subnet key. This means that only devices in possession of a given subnet key can communicate with other devices that are members of that subnet. Subnet keys can be created and assigned on an adhoc basis too. A great example is isolating nodes in different hotel rooms from each other.

\subsection{Node Removal, Key Refresh, and Trashcan Attacks}
As described above, nodes contain various Bluetooth® mesh security keys. Should a node become faulty and need to be disposed of, or if the owner decides to sell the node to another owner, it’s important that the device and the keys it contains cannot be used to mount an attack on the network the node was taken from.

A procedure for removing a node from a network is defined. The Provisioner application is used to add the node to a reject list and then a Key Refresh Procedure is initiated.

The Key Refresh Procedure issues all nodes in the network, except those which are members of the reject list, new network keys, application keys, and all related, derived data. In other words, the entire set of security keys which form the basis for network and application security are replaced.

As such, a node which was removed from the network, and which contains an old NetKey and old set of AppKeys, is no longer a member of the network and poses no threat.

\subsection{Privacy}
A Privacy Key, derived from the NetKey, is used to obfuscate network PDU header values, such as the source address. Obfuscation ensures that casual, passive eavesdropping cannot be used to track nodes and the people using them. It also makes attacks based upon traffic analysis difficult.

\subsection{Replay Attacks}
In network security, a replay attack is a technique whereby an eavesdropper intercepts and captures one or more messages and simply retransmits them later, with the goal of tricking the recipient into carrying out something which the attacking device is not authorized to do. A commonly cited example is a car’s keyless entry system being compromised by an attacker who intercepts the authentication sequence between the car’s owner and the car, later replaying those messages to gain entry to the car and steal it.

Bluetooth mesh networking protects against replay attacks by using two network PDU fields called the Sequence Number (SEQ) and IV Index. Elements increment the SEQ value every time they publish a message. A node which receives a message from an element containing an SEQ value less than or equal to that of the last valid message will discard it since it likely relates to a replay attack. Similarly, IV Index is a separate field considered alongside SEQ. IV Index values within messages from a given element must always be equal to or greater than the last valid message from that element.

\bib
\end{document}